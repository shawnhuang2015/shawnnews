ifndef CFLAGS
$(error CFLAGS is not set. Please run "make gpe" instead)
endif

EXECUTABLE=bin/release/poc_gpe_server
SOURCE_MAIN_DIR = src/customer/core_impl/gpe_impl
SOURCE_OTHER_DIR = src/customer/core_impl
SOURCES  = $(wildcard $(SOURCE_MAIN_DIR)/*.cpp)
SOURCES2 = $(wildcard $(SOURCE_OTHER_DIR)/*.cpp)

CC=g++
LIBB = gsdk/lib/release
LIBINCLUDE = -Isrc/customer
LIBINCLUDE += -Isrc/customer/core_impl/gpe_impl
LIBINCLUDE += -Igsdk/include
LIBINCLUDE += -Igsdk/include/third_party
#LIBINCLUDE += -Igsdk/include/third_party/yaml/usr/local/include
LIBINCLUDE += -Igsdk/include/third_party/sparsehash/usr/local/include
LIBINCLUDE += -Igsdk/include/third_party/glog/usr/local/include
LIBINCLUDE += -Igsdk/include/third_party/jsoncpp/include
LIBINCLUDE += -Igsdk/include/third_party/redis/deps/hiredis
#LIBINCLUDE += -Igsdk/include/third_party/zlib
#LIBINCLUDE += -Igsdk/include/third_party/zookeeper_c/include/zookeeper
#LIBINCLUDE += -Igsdk/include/third_party/librdkafka/include
LIBINCLUDE += -Igsdk/include/core/gpe
LIBINCLUDE += -Igsdk/include/core/gse
LIBINCLUDE += -Igsdk/include/olgp
LIBINCLUDE += -Igsdk/include/core/topology
LIBINCLUDE += -Igsdk/include/utility
LIBINCLUDE += -Igsdk/include/realtime

CFLAGS += -c -Wall -fmessage-length=0
CFLAGS += -Wno-unused -fpermissive -fno-omit-frame-pointer 
CFLAGS += -ldl
CFLAGS += -DRELEASE -O3 -DREMOVETESTASSERT
CFLAGS += -D__STDC_FORMAT_MACROS
#CFLAGS += -DComponentTest
CFLAGS += $(LIBINCLUDE)

LDFLAGS += -L$(LIBB)
LDFLAGS += -lolgplib
LDFLAGS += -lrestpplib
LDFLAGS += -lgpelib
LDFLAGS += -ldistlib
LDFLAGS += -lnetlib
LDFLAGS += -lmurmurhash
LDFLAGS += -ljson
LDFLAGS += -lsnappy
LDFLAGS += -lyaml-cpp
#LDFLAGS += -lboost_date_time
#LDFLAGS += -lboost_serialization
#LDFLAGS += -lboost_wserialization
LDFLAGS += -lboost_filesystem
LDFLAGS += -lboost_system
#LDFLAGS += -lboost_program_options
LDFLAGS += -lboost_thread
LDFLAGS += -lglog
#LDFLAGS += -lgtest
LDFLAGS += -lhiredis
LDFLAGS += -lzookeeper_mt
LDFLAGS += -lzmq
LDFLAGS += -lrdkafka
LDFLAGS += -lz
#LDFLAGS += -lmpi
LDFLAGS += -lpthread -ldl

UNAME_S := $(shell uname -s)
ifneq ($(UNAME_S),Darwin)
  LDFLAGS += -lcryptopp
  LDFLAGS += -lrt
endif

ODIR = objs
OBJECTS1  = $(patsubst $(SOURCE_MAIN_DIR)/%.cpp,$(ODIR)/%.o,$(SOURCES))
OBJECTS2 = $(patsubst $(SOURCE_OTHER_DIR)/%.cpp,$(ODIR)/%.o,$(SOURCES2))
OBJECTS = $(OBJECTS1) $(OBJECTS2)
OBJECTS_EXEC = $(OBJECTS)
ifneq "$(wildcard $(ODIR)/querydispatcher.o)" ""
  OBJECTS_EXEC = $(ODIR)/querydispatcher.o  $(OBJECTS)
  CFLAGS += -DRUNQUERY
endif

$(ODIR)/%.o: $(SOURCE_MAIN_DIR)/%.cpp
	$(CC) -o $@ $< $(CFLAGS) 

$(ODIR)/%.o: $(SOURCE_OTHER_DIR)/%.cpp
	$(CC) -o $@ $< $(CFLAGS)


all: $(SOURCES) $(EXECUTABLE)

$(EXECUTABLE): $(OBJECTS) 
	$(CC)  -o $@  $(OBJECTS_EXEC)  $(LDFLAGS)

clean:
	@# querydispatcher.o is NOT compiled by Makefile
	@if ls objs/*.o >/dev/null 2>&1  ; then ls objs/*.o | grep -v querydispatcher.o | xargs rm -f; fi
	@\rm -rf bin/release/*

#!/bin/bash
args=("$@")
if [ "$#" -ne 4 ]; then
    exit 1
fi


declare -a OS_TYPE_VERSION
get_os_signature() {
    CENTOS_FILE="/etc/redhat-release"
    UBUNTU_FILE="/etc/issue"
    if [ -f ${CENTOS_FILE} ]; then
        version=`cat /etc/redhat-release | egrep -o '[0-9]{1}.[0-9]{1}.[0-9]{2}'`
        OS_TYPE_VERSION="centos/${version}"
    else
        if [ -f ${UBUNTU_FILE} ]; then
            version=`cat /etc/issue | egrep -o '[0-9]{2}.[0-9]{2}'`
            OS_TYPE_VERSION="ubuntu/${version}"
        else
            version=`system_profiler SPSoftwareDataType | egrep -o '[0-9]{2}.[0-9]{2}.[0-9]{1}'`
            OS_TYPE_VERSION="os_x/${version}"
        fi
    fi
}




fetch_method=${args[0]}
src=${args[1]}
subsrc=${args[2]}
tgt=${args[3]}
mkdir -p ${tgt}
rm -rf ${tgt}/*


get_os_signature

echo ${OS_TYPE_VERSION}


if [ "${fetch_method}" == "local" ]; then
    tar -xzf ${src}/${tgt}/${subsrc}/${OS_TYPE_VERSION}/*.tar.gz -C .
    #cp -RL ${src}/${tgt}/${subsrc}/${OS_TYPE_VERSION}/* ${tgt}/
else
    mkdir -p "${tgt}_tmp"
    connect_str=$(grep -Po "(?<=^${fetch_method} ).*" config/sdk_resource.cfg)
    scp -r "${connect_str}:${src}/${tgt}/${subsrc}/${OS_TYPE_VERSION}/*" "${tgt}_tmp"
    tar -xzf "${tgt}_tmp/*.tar.gz" -C .
    rm -rf  "${tgt}_tmp"
fi



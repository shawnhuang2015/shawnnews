ifndef CFLAGS
$(error CFLAGS is not set. Please run "make rest" instead)
endif

EXECUTABLE=bin/release/poc_rest_server
VALIDATOR_EXECUTABLE=bin/release/check_endpoints
SOURCE_MAIN_DIR = src/customer/restpp_impl
SOURCES  = $(SOURCE_MAIN_DIR)/restpprun.cpp
VALIDATOR_SOURCES  = $(SOURCE_MAIN_DIR)/restppvalidator.cpp

CC=g++
LIBB = gsdk/lib/release
LIBINCLUDE = -Isrc/customer
LIBINCLUDE += -Isrc/realtime/restpp
LIBINCLUDE += -Isrc/realtime/restpp/system_filter
LIBINCLUDE += -Igsdk/include
LIBINCLUDE += -Igsdk/include/third_party
LIBINCLUDE += -Igsdk/include/third_party/yaml/usr/local/include
LIBINCLUDE += -Igsdk/include/third_party/sparsehash/usr/local/include
LIBINCLUDE += -Igsdk/include/third_party/glog/usr/local/include
LIBINCLUDE += -Igsdk/include/third_party/jsoncpp/include
LIBINCLUDE += -Igsdk/include/third_party/fcgi/include
#LIBINCLUDE += -Igsdk/include/third_party/redis/deps/hiredis
#LIBINCLUDE += -Igsdk/include/third_party/zlib
#LIBINCLUDE += -Igsdk/include/third_party/zookeeper_c/include/zookeeper
LIBINCLUDE += -Igsdk/include/third_party/librdkafka/include
LIBINCLUDE += -Igsdk/include/core/gpe
LIBINCLUDE += -Igsdk/include/core/gse
LIBINCLUDE += -Igsdk/include/olgp
LIBINCLUDE += -Igsdk/include/core/topology
LIBINCLUDE += -Igsdk/include/utility
LIBINCLUDE += -Igsdk/include/realtime

CFLAGS += -c -Wall -fmessage-length=0
CFLAGS += -Wno-unused -fpermissive -fno-omit-frame-pointer 
CFLAGS += -ldl
CFLAGS += -DRELEASE -O3 -DREMOVETESTASSERT
CFLAGS += -D__STDC_FORMAT_MACROS
#CFLAGS += -DComponentTest
CFLAGS += $(LIBINCLUDE)

LDFLAGS += -L$(LIBB)
LDFLAGS += -lolgplib
LDFLAGS += -lrestpplib
LDFLAGS += -lgpelib
LDFLAGS += -ldistlib
LDFLAGS += -lnetlib
LDFLAGS += -lmurmurhash
LDFLAGS += -ljson
LDFLAGS += -lsnappy
LDFLAGS += -lyaml-cpp
#LDFLAGS += -lboost_date_time
#LDFLAGS += -lboost_serialization
#LDFLAGS += -lboost_wserialization
LDFLAGS += -lboost_filesystem
LDFLAGS += -lboost_system
LDFLAGS += -lboost_program_options
LDFLAGS += -lboost_thread
LDFLAGS += -lglog
#LDFLAGS += -lgtest
LDFLAGS += -lhiredis
LDFLAGS += -lzookeeper_mt
LDFLAGS += -lzmq
LDFLAGS += -lrdkafka
LDFLAGS += -lrdkafka++
LDFLAGS += -lz
#LDFLAGS += -lmpi
LDFLAGS +=-lfcgi
LDFLAGS +=-lcurl
LDFLAGS += -lpthread -ldl

UNAME_S := $(shell uname -s)
ifneq ($(UNAME_S),Darwin)
  LDFLAGS += -lcryptopp
  LDFLAGS += -ljvm
  LDFLAGS += -lrt
else
  LDFLAGS += -framework javaVm
endif
ODIR = objs
OBJECTS  = $(patsubst $(SOURCE_MAIN_DIR)/%.cpp,$(ODIR)/%.o,$(SOURCES))
VALIDATOR_OBJECTS  = $(patsubst $(SOURCE_MAIN_DIR)/%.cpp,$(ODIR)/%.o,$(VALIDATOR_SOURCES))

$(ODIR)/%.o: $(SOURCE_MAIN_DIR)/%.cpp
	$(CC) -o $@ $< $(CFLAGS) 

all: $(SOURCES) $(VALIDATOR_SOURCES) $(EXECUTABLE) $(VALIDATOR_EXECUTABLE)

$(EXECUTABLE): $(OBJECTS) 
	$(CC)  -o $@  $(OBJECTS)  $(LDFLAGS)

$(VALIDATOR_EXECUTABLE): $(VALIDATOR_OBJECTS) 
	$(CC)  -o $@  $(VALIDATOR_OBJECTS)  $(LDFLAGS)

clean:
	rm -rf objs/*.o bin/release/*
